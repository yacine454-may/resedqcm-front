<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ResicoQCM â€” Login / Sign up</title>
  <link rel="icon" type="image/x-icon" href="/static/favicon.ico">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>
  <style>
    .bg-animated {
      background: radial-gradient(1200px 800px at 10% 10%, rgba(102,126,234,0.35), transparent 40%),
                  radial-gradient(1000px 600px at 90% 20%, rgba(118,75,162,0.35), transparent 40%),
                  radial-gradient(900px 600px at 50% 90%, rgba(56,189,248,0.25), transparent 40%),
                  linear-gradient(135deg, #0f172a, #111827);
      min-height: 100vh;
      position: relative;
      overflow: hidden;
    }
    .blob { position: absolute; border-radius: 50%; filter: blur(40px); opacity: 0.3; animation: float 14s ease-in-out infinite; }
    .blob-1 { width: 350px; height: 350px; background: #6366f1; top: -60px; left: -60px; }
    .blob-2 { width: 400px; height: 400px; background: #22d3ee; bottom: -80px; right: -80px; animation-delay: 2s; }
    .blob-3 { width: 300px; height: 300px; background: #a78bfa; bottom: 10%; left: 10%; animation-delay: 4s; }
    @keyframes float { 0%,100%{transform:translateY(0) translateX(0)} 50%{transform:translateY(-20px) translateX(10px)} }
    .glass { background: rgba(255,255,255,0.08); backdrop-filter: blur(14px); -webkit-backdrop-filter: blur(14px); border: 1px solid rgba(255,255,255,0.15); }
    .input-icon { position: absolute; left: 12px; top: 50%; transform: translateY(-50%); }
    .input-field { padding-left: 40px; padding-right: 40px; }
    .btn { transition: transform .05s ease, box-shadow .2s ease; }
    .btn:active { transform: translateY(1px); box-shadow: none; }
    .eye-btn { position: absolute; right: 10px; top: 50%; transform: translateY(-50%); color: #cbd5e1; }
  </style>
  <script>
    (function(){
      try {
        const token = localStorage.getItem('token');
        if (token) {
          const user = JSON.parse(localStorage.getItem('authUser')||'null');
          if (user && user.isActive) {
            // Keep user on login if they need to switch accounts; do not auto-redirect
          }
        }
      } catch(e) {}
    })();
  </script>
</head>
<body class="bg-animated text-white">
  <div class="blob blob-1"></div>
  <div class="blob blob-2"></div>
  <div class="blob blob-3"></div>

  <div class="min-h-screen flex items-center justify-center px-4">
    <div class="w-full max-w-md">
      <div class="text-center mb-6" data-aos="fade-down">
        <div class="inline-flex items-center justify-center w-14 h-14 rounded-2xl bg-indigo-500/20 border border-indigo-400/30">
          <i data-feather="book-open" class="w-7 h-7 text-indigo-300"></i>
        </div>
        <h1 class="mt-4 text-3xl font-extrabold tracking-tight">Sign in to ResicoQCM</h1>
        <p class="text-sm text-slate-300 mt-2">Need an account? Contact the admin on Messenger to receive your credentials, then log in with your unique code.</p>
      </div>

      <div class="glass rounded-2xl shadow-2xl p-6" data-aos="zoom-in">
        <div class="flex rounded-lg p-1 bg-white/5 border border-white/10 mb-6">
          <button id="tab-login" class="flex-1 py-2 rounded-md bg-indigo-500/20 text-indigo-100 font-semibold">Login</button>
          <button id="tab-signup" class="flex-1 py-2 rounded-md text-slate-200 hover:bg-white/5">Get Credentials</button>
        </div>

        <div id="alert" class="hidden mb-4 px-4 py-3 rounded-md text-sm"></div>

        <form id="form-login" class="space-y-4" autocomplete="on">
          <div class="relative">
            <i data-feather="mail" class="input-icon text-slate-300 w-5 h-5"></i>
            <input id="login-email" type="email" required placeholder="Email"
                   class="input-field w-full rounded-lg bg-white/10 border border-white/10 placeholder-slate-300 text-white focus:outline-none focus:ring-2 focus:ring-indigo-400 focus:border-transparent py-3">
          </div>
          <div class="relative">
            <i data-feather="lock" class="input-icon text-slate-300 w-5 h-5"></i>
            <input id="login-password" type="password" required placeholder="Password"
                   class="input-field w-full rounded-lg bg-white/10 border border-white/10 placeholder-slate-300 text-white focus:outline-none focus:ring-2 focus:ring-indigo-400 focus:border-transparent py-3">
            <button type="button" class="eye-btn" data-eye="login-password"><i data-feather="eye"></i></button>
          </div>
          <div class="relative">
            <i data-feather="key" class="input-icon text-slate-300 w-5 h-5"></i>
            <input id="login-code" type="text" required placeholder="Unique code"
                   class="input-field uppercase w-full rounded-lg bg-white/10 border border-white/10 placeholder-slate-300 text-white focus:outline-none focus:ring-2 focus:ring-indigo-400 focus:border-transparent py-3">
          </div>
          <button id="btn-login" type="submit"
                  class="btn w-full py-3 rounded-lg bg-indigo-500 hover:bg-indigo-600 text-white font-semibold shadow-lg shadow-indigo-900/30">
            Sign In
          </button>
        </form>

        <!-- Signup is handled by admin via Messenger -->
        <div id="signup-info" class="space-y-4 hidden">
          <div class="text-slate-200 text-sm">To create an account, please contact the admin on Messenger. You will receive your credentials (email, password, unique code).</div>
          <a href="https://www.messenger.com/e2ee/t/822661896754735/" target="_blank" rel="noopener noreferrer"
             class="btn w-full py-3 rounded-lg bg-emerald-500 hover:bg-emerald-600 text-white font-semibold shadow-lg shadow-emerald-900/30 text-center block">
            Contact Admin on Messenger
          </a>
        </div>

        <form id="form-activate" class="space-y-4 hidden" autocomplete="off">
          <div class="text-slate-200 text-sm">Enter your subscription code to activate your account:</div>
          <div class="grid grid-cols-2 gap-3 text-sm">
            <div class="bg-white/5 border border-white/10 rounded-md p-2">Code4A â†’ 4th year</div>
            <div class="bg-white/5 border border-white/10 rounded-md p-2">Code5A â†’ 5th year</div>
            <div class="bg-white/5 border border-white/10 rounded-md p-2">Code6A â†’ 6th year</div>
            <div class="bg-white/5 border border-white/10 rounded-md p-2">CodeRES â†’ Residents (full)</div>
          </div>
          <div class="relative">
            <i data-feather="key" class="input-icon text-slate-300 w-5 h-5"></i>
            <input id="activate-code" type="text" required placeholder="Enter code (e.g., Code4A)"
                   class="input-field uppercase w-full rounded-lg bg-white/10 border border-white/10 placeholder-slate-300 text-white focus:outline-none focus:ring-2 focus:ring-indigo-400 focus:border-transparent py-3">
          </div>
          <button id="btn-activate" type="submit"
                  class="btn w-full py-3 rounded-lg bg-indigo-500 hover:bg-indigo-600 text-white font-semibold shadow-lg shadow-indigo-900/30">
            Activate Account
          </button>
        </form>
      </div>

      <p class="text-center text-slate-400 text-xs mt-6" data-aos="fade-up">
          headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
          body: JSON.stringify({ code })
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data.message || 'Activation failed');
        localStorage.setItem('authUser', JSON.stringify(data.user));
        setAlert('success', 'Account activated! Redirecting...');
        &copy; 2025 ResicoQCM. All rights reserved.
      </p>
    </div>
  </div>

  <script>
    // API Base URL - works for both local development and production
    const API_BASE = (window.location.hostname === 'localhost')
      ? 'http://localhost:8001/api'
      : '/api';
    
    console.log('ðŸ”— API_BASE:', API_BASE);
    const alertBox = document.getElementById('alert');
    const tabLogin = document.getElementById('tab-login');
    const tabSignup = document.getElementById('tab-signup');
    const formLogin = document.getElementById('form-login');
    const formSignup = document.getElementById('form-signup');
    const signupInfo = document.getElementById('signup-info');
    const formActivate = document.getElementById('form-activate');

    function setAlert(type, msg) {
      alertBox.classList.remove('hidden');
      const classes = {
        success: 'bg-emerald-500/15 border border-emerald-400/40 text-emerald-200',
        error: 'bg-rose-500/15 border border-rose-400/40 text-rose-200',
        info: 'bg-indigo-500/15 border border-indigo-400/40 text-indigo-200'
      };
      alertBox.className = 'mb-4 px-4 py-3 rounded-md text-sm ' + (classes[type] || classes.info);
      alertBox.textContent = msg;
      if (type !== 'error') setTimeout(() => alertBox.classList.add('hidden'), 3500);
    }

    function switchTab(tab) {
      const onLogin = tab === 'login';
      formLogin.classList.toggle('hidden', !onLogin);
      signupInfo.classList.toggle('hidden', onLogin);
      formActivate.classList.add('hidden');
      tabLogin.classList.toggle('bg-indigo-500/20', onLogin);
      tabLogin.classList.toggle('text-indigo-100', onLogin);
      tabSignup.classList.toggle('bg-indigo-500/20', !onLogin);
      tabSignup.classList.toggle('text-indigo-100', !onLogin);
      alertBox.classList.add('hidden');
    }

    tabLogin.addEventListener('click', () => switchTab('login'));
    tabSignup.addEventListener('click', () => switchTab('signup'));

    document.querySelectorAll('[data-eye]').forEach(btn => {
      btn.addEventListener('click', () => {
        const id = btn.getAttribute('data-eye');
        const field = document.getElementById(id);
        field.type = field.type === 'password' ? 'text' : 'password';
        btn.innerHTML = '';
        const icon = document.createElement('i');
        icon.setAttribute('data-feather', field.type === 'password' ? 'eye' : 'eye-off');
        btn.appendChild(icon);
        feather.replace();
      });
    });

    async function handleLogin(e) {
      e.preventDefault();
      const email = document.getElementById('login-email').value.trim();
      const password = document.getElementById('login-password').value;
      const codeRaw = document.getElementById('login-code').value.trim();
      const code = codeRaw.toUpperCase();
      if (!email || !password || !code) return setAlert('error', 'Please fill in all fields (email, password, code).');
      const btn = document.getElementById('btn-login');
      btn.disabled = true; btn.textContent = 'Signing in...';
      try {
        const res = await fetch(`${API_BASE}/user/login`, {
          method: 'POST', headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, password, code })
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data.message || 'Login failed');
        localStorage.setItem('token', data.token);
        localStorage.setItem('authUser', JSON.stringify(data.user));
        if (!data.user.isActive) {
          setAlert('info', 'Account not active. Please enter your subscription code.');
          formLogin.classList.add('hidden');
          formSignup.classList.add('hidden');
          formActivate.classList.remove('hidden');
        } else {
          if (data.user.isAdmin) {
            window.location.href = 'admin.html';
          } else {
            window.location.href = 'index.html';
          }
        }
      } catch (err) { setAlert('error', err.message); }
      finally { btn.disabled = false; btn.textContent = 'Sign In'; }
    }

    async function handleSignup(e) {
      e.preventDefault();
      const username = document.getElementById('signup-username').value.trim();
      const email = document.getElementById('signup-email').value.trim();
      const password = document.getElementById('signup-password').value;
      if (!username || !email || !password) return setAlert('error', 'Please fill in all fields.');
      if (password.length < 6) return setAlert('error', 'Password must be at least 6 characters.');
      const btn = document.getElementById('btn-signup');
      btn.disabled = true; btn.textContent = 'Creating...';
      try {
        const res = await fetch(`${API_BASE}/user/signup`, {
          method: 'POST', headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username, email, password })
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data.message || 'Signup failed');
        localStorage.setItem('token', data.token);
        localStorage.setItem('authUser', JSON.stringify(data.user));
        setAlert('success', 'Account created! Enter your activation code.');
        formSignup.classList.add('hidden');
        formLogin.classList.add('hidden');
        formActivate.classList.remove('hidden');
      } catch (err) { setAlert('error', err.message); }
      finally { btn.disabled = false; btn.textContent = 'Create Account'; }
    }

    async function handleActivate(e) {
      e.preventDefault();
      const code = document.getElementById('activate-code').value.trim();
      if (!code) return setAlert('error', 'Please enter your subscription code.');
      const btn = document.getElementById('btn-activate');
      btn.disabled = true; btn.textContent = 'Activating...';
      try {
        const token = localStorage.getItem('token');
        const res = await fetch(`${API_BASE}/user/activate`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
          body: JSON.stringify({ code })
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data.message || 'Activation failed');
        localStorage.setItem('authUser', JSON.stringify(data.user));
        setAlert('success', 'Account activated! Redirecting...');
        setTimeout(() => window.location.href = 'index.html', 800);
      } catch (err) { setAlert('error', err.message); }
      finally { btn.disabled = false; btn.textContent = 'Activate Account'; }
    }

    formLogin.addEventListener('submit', handleLogin);
    // Signup is disabled; users must contact admin via Messenger
    formActivate.addEventListener('submit', handleActivate);

    AOS.init({ duration: 800, easing: 'ease-in-out', once: true });
    feather.replace();
  </script>
</body>
</html>